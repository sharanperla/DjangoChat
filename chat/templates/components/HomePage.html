{% load static %}
<section class="main">
  <div>
    <center>
      <h1>Hello, Welcome {{request.user}}</h1>
    </center>
    {% if request.user.is_authenticated %}
    <center> Logout the chat Page <a href="{% url 'logout-user' %}">Logout</a></center>
    {% endif %}
  </div>

  <div class="homeMessageSquare" id="messageMenu">
    <img src="{% static 'images/messageSquare.svg' %}" alt="" class="homeMessageSquareSvg" />
  </div>

  <!-- popup chat list -->
  <div class="popMenu" id="popMenu">
    <div id="popMenu1" class="popMenu1">
      {% block searchBar %}
      {% include '../assets/SearchBar.html' %}
      {% endblock %}
      <!-- searchresults comes here -->
      <div class="searchResultContainer"
        style="background-color: rgba(224, 223, 221, 0.364); padding: 5px; margin-top: 10px; border-radius: 10px; display: none; "
        id="searchResultsTitle">
        <h1 style="font-size: 14px; text-align: center">Search results</h1>
        <div id="searchResults" class="searchResults">

        </div>
      </div>
      <!-- user list comes here -->
      <div class="userListContainer">
        {% for user in online_users %}
        <div class="homePageUsercard" id="loadChatMenuBtn" data-username="{{ user.username }}">
          <div class="avatar-container">
            <img class="homePageUsercardImage"
              src="https://plus.unsplash.com/premium_photo-1671656349322-41de944d259b?q=80&w=1887&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
              alt="User Avatar" />
          </div>
          <div class="popMenuDescDiv">
            <h4 class="popMenuUserName">{{ user.username }}</h4>
            <p class="popMenuMessagePreview">
              <span class="highlightedUserName">Sharan&nbsp;</span> hey how are you, have you seen my message
            </p>
          </div>
        </div>

        {% endfor %}


      </div>

    </div>
    <div id="chatMenuContainer" class="chatMenuContainer">

    </div>
  </div>

</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var messageMenu = document.getElementById("messageMenu");
    var popMenu = document.getElementById("popMenu");

    // Toggle the visibility of the menu on click
    messageMenu.addEventListener("click", function () {
      console.log("clicked");
      if (popMenu.style.display === "none" || popMenu.style.display === "") {
        popMenu.style.display = "flex";
      } else {
        popMenu.style.display = "none";
      }
    });

    // Hide the menu if clicked outside of it
    // document.addEventListener("click", function (event) {
    //   if (
    //     !messageMenu.contains(event.target) &&
    //     !popMenu.contains(event.target)
    //   ) {
    //     popMenu.style.display = "none";
    //   }
    // });
  });

</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const userCards = document.querySelectorAll('.homePageUsercard');
    userCards.forEach(card => {
      const username = card.getAttribute('data-username');
      card.addEventListener('click', function () {
        initiatePrivateChat(username);
      });
    });
  });

</script>

<script>
  function toggleEmoji(recipient) {
    const emojiPickerId = 'emoji-picker-container-' + recipient;
    const emojiPicker = document.getElementById(emojiPickerId);
    if (emojiPicker) {
      emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    }
  }

  function selectEmoji(emoji, recipient) {
    const chatInputId = 'chatInput-' + recipient;
    const chatInput = document.getElementById(chatInputId);
    if (chatInput) {
      chatInput.value += emoji;
    } else {
      console.error('Chat input field not found for recipient:', recipient);
    }

    // Hide the emoji picker after selection
    toggleEmoji(recipient);
  }

</script>
<script>
  function toggleDropdown() {
    const dropdown = document.getElementById('dropdownMenu');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  }

  function clearChat() {
    // Implement your chat clearing logic here
    alert('Chat cleared!');
    // Hide the dropdown after action
    toggleDropdown();
  }

  // Close dropdown if clicked outside
  document.addEventListener('click', function (event) {
    const isClickInside = document.querySelector('.chatMenu-dropdown-container').contains(event.target);
    if (!isClickInside) {
      document.getElementById('dropdownMenu').style.display = 'none';
    }
  });
</script>
 <!-- audio message -->
<script>
  // Start recording
  let mediaRecorder;
let audioChunks = [];

function startRecording(recipient) {
  const audiocont = document.getElementById(`recording-container-${recipient}`);
  audiocont.style.display = 'block';

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      
      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        sendAudioMessage(audioBlob, recipient);
      };

      mediaRecorder.start();
    })
    .catch(error => console.error('Error accessing media devices.', error));
}
function stopRecording(recipient) {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        sendAudioMessage(audioBlob, recipient);
      };
    console.log('Recording stopped.');
  } else {
    console.error('No active recording to stop.');
  }
  
  const audiocont = document.getElementById(`recording-container-${recipient}`);
  audiocont.style.display = 'none';
}

// Add more detailed logging
function sendAudioMessage(audioBlob, recipient) {
  console.log('Sending audio message...');
  const formData = new FormData();
  formData.append('audio', audioBlob, 'audio.wav');

  fetch('/upload-audio/', {
    method: 'POST',
    body: formData,
    // headers: {
    //   'X-CSRFToken': getCSRFToken()
    // }
  })
    .then(response => response.json())
    .then(data => {
      if (data.file_url) {
        console.log('Sending audio URL over WebSocket:', data.file_url);
        chatSocket.send(JSON.stringify({
          audio_url: data.file_url,
          username: "{{ request.user.username }}",
          recipient: recipient
        }));
        console.log('sent')

      } else {
        console.error('Error: No file URL returned');
      }
    })
    .catch(error => console.error('Error sending audio message:', error));
}


  // // Update sendAudioMessage function to accept chatSocket
  // function sendAudioMessage(audioBlob, recipient, chatSocket) {
  //   const formData = new FormData();
  //   formData.append('audio', audioBlob, 'audio.wav');

  //   fetch('/upload-audio/', { // Ensure this URL is correct
  //     method: 'POST',
  //     body: formData,
  //     // headers: {
  //     //   'X-CSRFToken': getCSRFToken() // Ensure you have a function to retrieve the CSRF token
  //     // }
  //   })
  //     .then(response => response.json())
  //     .then(data => {
  //       if (data.file_url) {
  //         chatSocket.send(JSON.stringify({
  //           audio_url: data.file_url,
  //           username: "{{ request.user.username }}",
  //           recipient: recipient
  //         }));
  //       } else {
  //         console.error('Error: No file URL returned');
  //       }
  //     })
  //     .catch(error => console.error('Error sending audio message:', error));
  // }
// Function to get CSRF Token
// function getCSRFToken() {
//     const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
//     if (csrfTokenElement) {
//         return csrfTokenElement.getAttribute('content');
//     } else {
//         console.error('CSRF token element not found');
//         return null;
//     }
// }

</script>
